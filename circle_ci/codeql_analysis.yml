version: 2.1

jobs:
  codeql-analysis:
    docker:
      - image: cimg/python:3.10 # Use a suitable image for your Python & Linux environment

    steps:
      - checkout

      - run:
          name: Install Python (if needed)
          command: |
            chmod +x ./install_python.sh
            ./install_python.sh

      - run:
          name: Install CodeQL Wrapper
          command: |
            pip install -i https://test.pypi.org/simple/ codeql-wrapper
            codeql-wrapper --version

      - run:
          name: Run CodeQL Analysis
          command: |
            codeql-wrapper --verbose analyze ./monorepo --monorepo --upload-sarif
          environment:
            GITHUB_TOKEN: << pipeline.parameters.github_token >>

parameters:
  github_token:
    type: env_var_name
    default: GITHUB_TOKEN

workflows:
  version: 2
  manual_codeql:
    jobs:
      - codeql-analysis:
          github_token: GITHUB_TOKEN # This must be defined as a project/env var in CircleCI
