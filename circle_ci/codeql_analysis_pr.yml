version: 2.1

jobs:
  codeql-analysis:
    docker:
      - image: cimg/python:3.13 # Use a suitable image for your Python & Linux environment

    steps:
      - checkout

      - run:
          name: Install Python (if needed)
          command: |
            chmod +x ./install_python.sh
            ./install_python.sh

      - run:
          name: Install CodeQL Wrapper
          command: |
            # https://test.pypi.org/project/codeql-wrapper/
            pip install -i https://test.pypi.org/simple/ codeql-wrapper
            codeql-wrapper --version

      - run:
          name: Run CodeQL Analysis
          command: |
            export GITHUB_TOKEN=${PAT} # Set PAT as environment variable in CircleCI project settings
            # ----------------------------
            # set variables for pull request context
            # ----------------------------
            if [ -n "$CIRCLE_PULL_REQUEST" ]; then
              echo "Running in a pull request context"
              PR_NUMBER=$(basename $CIRCLE_PULL_REQUEST)
              REPO_PATH=$(echo "$CIRCLE_PULL_REQUEST" | sed -E 's|https://github.com/([^/]+/[^/]+)/pull/[0-9]+|\1|')
              BASE_REF=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                https://api.github.com/repos/${REPO_PATH}/pulls/${PR_NUMBER} \
                | jq -r .base.ref)
              REF=refs/pull/${PR_NUMBER}/merge
            else
              echo "Running in a non-pull request context"
              BASE_REF=$CIRCLE_BRANCH
              REF="HEAD^"
            fi
            printenv
            curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user
            codeql-wrapper --verbose analyze ./monorepo \
              --monorepo \
              --upload-sarif \
              --only-changed-files \
              --base-ref origin/"$BASE_REF" \
              --ref "$REF"

workflows:
  version: 2
  codeql-workflow:
    jobs:
      - codeql-analysis
