# This pipeline is manually triggered
trigger: none

pool:
  vmImage: ubuntu-latest

steps:
  - script: |
      chmod +x ./install_python.sh
      ./install_python.sh
    displayName: "Install Python"

  - script: |
      pip install -i https://test.pypi.org/simple/ codeql-wrapper
      codeql-wrapper --version
    displayName: "Install CodeQL Wrapper"

  - script: |
      git config --global url."https://x-access-token:$(PAT)@github.com/".insteadOf "https://github.com/"
      codeql-wrapper --verbose analyze ./monorepo --monorepo --upload-sarif \
        --only-changed-files \
        --base-ref "$(System.PullRequest.TargetBranch)" \
        --ref="$(System.PullRequest.SourceBranch)" \
        --max-workers 1
    displayName: "Run CodeQL Analysis"
    env:
      GITHUB_TOKEN: $(PAT) # Define this secret in Azure Pipeline variables
