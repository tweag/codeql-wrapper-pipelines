# This pipeline is manually triggered
trigger:
  branches:
    include:
      - "*"
pr:
  branches:
    include:
      - "*"

pool:
  vmImage: ubuntu-latest

steps:
  - checkout: self
    fetchDepth: 0

  - script: |
      chmod +x ./install_python.sh
      ./install_python.sh
    displayName: "Install Python"

  - script: |
      # https://test.pypi.org/project/codeql-wrapper/
      pip install -i https://test.pypi.org/simple/ codeql-wrapper
      codeql-wrapper --version
    displayName: "Install CodeQL Wrapper"

  - script: |
      curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user
      printenv
      codeql-wrapper --verbose analyze ./monorepo \
        --monorepo \
        --upload-sarif \
        --only-changed-files \
        --ref refs/remotes/main --base-ref "HEAD^"

    displayName: "Run CodeQL Analysis"
    env:
      GITHUB_TOKEN: $(PAT) # Define this secret in Azure Pipeline variables
