pipeline {
    agent any
    
    environment {
        GITHUB_TOKEN = credentials('PAT2')
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup Python') {
            steps {
                sh '''#!/bin/bash                    
                    python3 -m venv venv
                    . venv/bin/activate

                    pip uninstall codeql-wrapper -y || true
                    
                    echo "Upgrading pip, setuptools, and wheel..."
                    python3 -m pip install --upgrade --force-reinstall pip setuptools wheel packaging gitpython==3.1.45
                    pip install --extra-index-url https://test.pypi.org/simple/ codeql-wrapper==0.2.15
                '''
            }
        }
        
        stage('CodeQL Analysis') {
            steps {
                withCredentials([string(credentialsId: 'PAT2', variable: 'GITHUB_TOKEN')]) {
                    sh '''#!/bin/bash
                        . venv/bin/activate
                        echo "Base Ref (Target Branch): $CHANGE_TARGET"
                        echo "Ref (Source Branch): $CHANGE_BRANCH"

                        curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user

                        codeql-wrapper --verbose analyze ./monorepo --monorepo --upload-sarif --ref $CHANGE_BRANCH --base-ref $CHANGE_TARGET
                    '''
                }
            }
        }

        stage('Archive Results') {
            steps {
                archiveArtifacts artifacts: 'codeql-results/**/*', allowEmptyArchive: true
            }
        }
    }
}
