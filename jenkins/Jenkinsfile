pipeline {
    agent any
    
    environment {
        GITHUB_TOKEN = credentials('codeql-wrapper-token')
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup Python') {
            steps {
                sh '''#!/bin/bash
                    if command -v python3 &> /dev/null; then
                        echo "Python3 is already installed:"
                        python3 --version
                    else
                        echo "Python3 not found. Installing Python3..."
                        apt update
                        apt install -y python3
                        echo "Python3 installation completed:"
                        python3 --version
                    fi
                    
                    # Check if pip is available, if not install it
                    if ! python3 -m pip --version &> /dev/null; then
                        echo "pip not found. Installing pip..."
                        apt install -y python3-pip
                    fi
                    
                    # Upgrade pip, setuptools, and wheel
                    echo "Upgrading pip, setuptools, and wheel..."
                    python3 -m pip install --upgrade pip setuptools wheel packaging gitpython
                    
                    python3 -m pip install --upgrade pip
                    pip3 install codeql-wrapper
                '''
            }
        }
        
        stage('CodeQL Analysis') {
            steps {
                sh '''#!/bin/bash
                    
                    codeql-wrapper analyze ${WORKSPACE} \
                      --monorepo \
                      --verbose \
                      --upload-sarif \
                      --repository owner/repository \
                      --commit-sha ${GIT_COMMIT} \
                      --ref ${GIT_BRANCH}
                '''
            }
        }
    }
    
    post {
        always {
            archiveArtifacts artifacts: 'codeql-results/**/*', allowEmptyArchive: true
        }
    }
}
